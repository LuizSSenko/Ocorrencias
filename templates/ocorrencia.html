<!doctype html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Ocorrência {{ ocorrencia.numero }}</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    .pendente { background-color: #f8d7da; }
    .concluida { background-color: #d4edda; }
    .comentarios a { margin-right: 10px; }
    .descricao { white-space: pre-wrap; }
    .comentario-texto { white-space: pre-wrap; }
    .botao-especial { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Ocorrência {{ ocorrencia.numero }}</h1>
  <a href="{{ url_for('index') }}">Voltar para a lista</a>
  
  <table>
    <tr>
      <th>Número da Ocorrência</th>
      <td>{{ ocorrencia.numero }}</td>
    </tr>
    <tr>
      <th>Tipo da Ocorrência</th>
      <td>{{ ocorrencia.tipo }}</td>
    </tr>
    <tr>
      <th>Estado</th>
      <td class="{% if ocorrencia.estado == 'Pendente' %}pendente{% else %}concluida{% endif %}">
        {{ ocorrencia.estado }}
      </td>
    </tr>
    <tr>
      <th>Data de envio</th>
      <td>{{ ocorrencia.data_envio }}</td>
    </tr>
    <tr>
      <th>Data da última atualização</th>
      <td>{{ ocorrencia.atualizado }}</td>
    </tr>
    <tr>
      <th>Descrição da Ocorrência</th>
      <td>
        <div id="descricao-texto" class="descricao">{{ ocorrencia.descricao }}</div>
        <a href="#" id="editar-link" onclick="toggleEditor(); return false;">[Editar]</a>
        <div id="editor-container" style="display:none;">
          <form action="{{ url_for('editar_ocorrencia', ocorrencia_id=ocorrencia.id) }}" method="post">
            <textarea name="descricao" id="descricao-editor" cols="50" rows="10">{{ ocorrencia.descricao }}</textarea><br>
            <button type="submit">Salvar</button>
            <button type="button" onclick="toggleEditor();">Cancelar</button>
          </form>
        </div>
      </td>
    </tr>
    <tr>
      <th>Arquivos anexados</th>
      <td>
        {% set arquivos = ocorrencia.get_arquivos() %}
        {% if arquivos|length > 0 %}
          <ul>
            {% for arquivo in arquivos %}
              <li>
                <a href="{{ url_for('uploaded_file', filename=arquivo['nome']) }}" target="_blank">{{ arquivo['nome'] }}</a>
                - {{ arquivo['upload_data'] }}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          Nenhum arquivo anexado.
        {% endif %}
      </td>
    </tr>
  </table>
  
  <!-- Formulário para alterar o estado -->
  <h2>Alterar Estado</h2>
  <form action="{{ url_for('alterar_estado', ocorrencia_id=ocorrencia.id) }}" method="post">
    <select name="estado">
      <option value="Pendente" {% if ocorrencia.estado == 'Pendente' %}selected{% endif %}>Pendente</option>
      <option value="Concluída" {% if ocorrencia.estado == 'Concluída' %}selected{% endif %}>Concluída</option>
    </select>
    <button type="submit">Alterar Estado</button>
  </form>
  
  <!-- Botão "Excluir Ocorrência" movido para abaixo da tabela -->
  <div style="margin-top: 10px;">
    <form action="{{ url_for('excluir_ocorrencia', ocorrencia_id=ocorrencia.id) }}" method="post" onsubmit="return confirm('Tem certeza que deseja excluir esta ocorrência?');">
      <button type="submit">Excluir Ocorrência</button>
    </form>
  </div>
  
  <br>

  <h2>Comentários</h2>
  <button onclick="toggleNovoComentario()">Adicionar comentário</button>
  <div id="novo-comentario-container" style="display:none;">
    <form action="{{ url_for('adicionar_comentario', ocorrencia_id=ocorrencia.id) }}" method="post">
      <textarea id="novo-comentario-textarea" name="comentario" cols="50" rows="3" placeholder="Digite seu comentário" required></textarea><br>
      <button type="submit">Salvar Comentário</button>
      <button type="button" onclick="toggleNovoComentario()">Cancelar</button>
    </form>
  </div>

  {% set comentarios = ocorrencia.get_comentarios() %}
  {% if comentarios|length > 0 %}
  <table class="comentarios">
    <thead>
      <tr>
        <th>Comentário</th>
      </tr>
    </thead>
    <tbody>
      {% for c in comentarios %}
      <tr>
        <td>
          <div id="comentario-texto-{{ loop.index0 }}" class="comentario-texto">{{ c.texto }}</div>
          <a href="#" id="editar-link-{{ loop.index0 }}" onclick="toggleEditorComentario({{ loop.index0 }}); return false;">[Editar]</a>
          <div id="editor-container-{{ loop.index0 }}" style="display:none;">
            <form action="{{ url_for('editar_comentario', ocorrencia_id=ocorrencia.id, comentario_index=loop.index0) }}" method="post">
              <textarea name="comentario" cols="50" rows="5">{{ c.texto }}</textarea><br>
              <button type="submit">Salvar</button>
              <button type="button" onclick="toggleEditorComentario({{ loop.index0 }});">Cancelar</button>
            </form>
            <br>
          </div>
          <br>
          <small>
            {{ c.data }}
            {% if c.editado %}
              - <em>Editado em: {{ c.editado }}</em>
            {% endif %}
          </small>
          <br>
          <form action="{{ url_for('excluir_comentario', ocorrencia_id=ocorrencia.id, comentario_index=loop.index0) }}" method="post" style="display:inline;" onsubmit="return confirm('Deseja remover este comentário?');">
            <button type="submit">Remover</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <h2>Histórico desta Ocorrência</h2>
  {% set historico = ocorrencia.get_historico() %}
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Evento</th>
      </tr>
    </thead>
    <tbody>
      {% for h in historico %}
      <tr>
        <td>{{ h.data }}</td>
        <td>{{ h.evento }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a href="{{ url_for('index') }}">Voltar para a lista</a>

  <script>
    function toggleEditor() {
      var editor = document.getElementById('editor-container');
      var descricaoTexto = document.getElementById('descricao-texto');
      var editarLink = document.getElementById('editar-link');
      if (editor.style.display === 'none') {
        editor.style.display = 'block';
        descricaoTexto.style.display = 'none';
        editarLink.style.display = 'none';
      } else {
        editor.style.display = 'none';
        descricaoTexto.style.display = 'block';
        editarLink.style.display = 'inline';
      }
    }

    function toggleEditorComentario(index) {
      var editor = document.getElementById('editor-container-' + index);
      var texto = document.getElementById('comentario-texto-' + index);
      var link = document.getElementById('editar-link-' + index);
      if (editor.style.display === 'none') {
        editor.style.display = 'block';
        texto.style.display = 'none';
        link.style.display = 'none';
      } else {
        editor.style.display = 'none';
        texto.style.display = 'block';
        link.style.display = 'inline';
      }
    }
    
    function toggleNovoComentario() {
      var container = document.getElementById('novo-comentario-container');
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        document.getElementById('novo-comentario-textarea').focus();
      } else {
        container.style.display = 'none';
      }
    }
  </script>
</body>
</html>
